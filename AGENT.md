# AGENT.md — Lan 项目开发原则（v1）

## 项目愿景
打造一个 **像 OpenCode / Pi / Claude Code / Codex 一样强大**，但在速度、体验与可扩展性上更进一步的 Agent CLI：

- **更快**：响应快、启动快、工具调用快
- **更好**：质量稳定、行为可预期、错误可解释
- **更方便**：默认好用、学习成本低、开箱即用

技术路线：
- 核心语言：**Zig**
- 交互形态：**直觉化 TUI + CLI**
- 能力扩展：**Skill 原生（一等公民）**，可自动安装、执行与隔离

设计哲学（基于 `badlogic/pi-mono` 启发）：
- 简单高效的 Linux 哲学
- 优雅但可无限扩展
- 学习他们、成为他们、超越他们

---

## 核心设计原则

### 1) 快速优先（Latency First）
- 首屏可用时间最小化（TTI）
- 默认流式输出，避免“黑屏等待”
- 工具调用并发化、可中断、可超时
- 每个关键链路都可观测（耗时、重试、失败原因）

### 2) 默认可用（Sane by Default）
- 新用户安装后无需复杂配置即可完成首轮对话
- 默认模型、默认技能、默认布局即“够好”
- 命令与快捷键尽量与主流 Agent CLI 习惯一致

### 3) 简洁交互（Intuitive TUI）
- 界面信息层次清晰：状态、输出、输入三层分离
- 降低模式切换成本：少弹窗、少打断
- 所有“危险动作”可撤销/可确认

### 4) Skill 原生（Skills as First-Class）
- Skill 应可声明依赖、权限、输入输出、超时与隔离策略
- 支持自动安装、版本锁定、校验与升级
- 运行时具备最小权限、可审计日志、失败可回放

### 5) 可扩展架构（Composable Core）
- 核心最小化，能力插件化
- 统一 Tool/Skill 调用协议，减少重复胶水代码
- 多模型、多提供商、多运行环境可平滑接入

### 6) 可靠与可恢复（Reliability）
- 网络/模型故障可自动降级
- 会话、配置、历史可恢复
- 错误信息具备可操作性（告诉用户下一步怎么修）

### 7) 安全边界明确（Secure by Design）
- 默认最小权限，不隐式越权
- 外部副作用动作（写文件/执行命令/网络）明确告知
- 机密信息不落盘或可控加密存储

---

## 体验红线（不可退让）
1. 不做“看起来聪明但行为不可预测”的交互
2. 不做“功能很多但默认不可用”的设计
3. 不做“把复杂性甩给用户”的配置系统
4. 不做“无日志、无指标、无诊断”的黑箱

---

## 工程决策准则
当出现方案分歧时，按如下优先级决策：

1. 用户任务完成率
2. 端到端延迟（p50 / p95）
3. 可维护性（代码复杂度、测试成本）
4. 扩展性（是否阻断未来 Skill/Tool 接入）
5. 实现速度（短期交付）

---

## 版本推进原则
- 小步快跑：每周有可演示增量
- 每个版本必须包含：
  - 用户可感知改进
  - 性能或稳定性改进
  - 至少一项开发者体验改进

## 开发方法（强制）
- 默认采用 **TDD/BDD** 驱动开发，按功能特性选择：
  - 核心逻辑、协议、解析器、工具运行时：优先 **TDD**（先写失败测试，再实现，再重构）
  - 交互行为、CLI/TUI 用户流程、端到端场景：优先 **BDD**（Given/When/Then 场景先行）
- 新功能开发顺序：
  1. 先写测试或行为场景（失败）
  2. 最小实现使其通过
  3. 重构并保持测试通过
  4. 更新 `docs/TASKS.md` 状态与验收结果
- 没有测试/场景的功能不算完成（除非明确标注为 spike/prototype）

---

## 计划与执行机制（强制）
- 路线图使用：`docs/ROADMAP.md`
- 任务清单使用：`docs/TASKS.md`
- `TASKS.md` 必须由 roadmap 拆解生成，不允许脱节
- 开发过程中实时更新 `TASKS.md`（完成即勾选、阻塞即标注、下一步即时刷新）
- 若 roadmap 阶段状态变化，需同步更新 `ROADMAP.md`

## Git 提交与同步规范（强制）

### Commit 原子化
- 一个 commit 只包含一个逻辑变更，禁止把无关修改打包提交。
- 每个 commit 应可独立理解、独立审查、尽量独立回滚。
- 提交前保证变更范围内处于健康状态（相关测试通过；临时态须显式标注 WIP）。
- 提交信息清晰，建议采用 Conventional Commits。

### 及时 Push
- 完成一个原子单元并通过该单元检查后，立即 push。
- 连续开发时，最晚每 60–90 分钟 push 一次。
- 上下文切换前必须 push（切任务/切项目/开会/休息/收工）。
- 高风险里程碑（大重构、关键配置、冲突高风险文件）优先即时 push。
- 不允许长期堆积本地 commits 而不做远端备份。

## 当前执行入口
- 方向与阶段：`docs/ROADMAP.md`
- 日常执行与进度：`docs/TASKS.md`
